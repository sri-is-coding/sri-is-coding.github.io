<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pastel Pomodoro Timer</title>

  <!-- Elegant handwritten-style font -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital@1&display=swap" rel="stylesheet">

  <style>
    :root{
      --pill-bg: #F3EFEA; /* pastel pearl */
      --text: #111111;
      --muted: rgba(17,17,17,0.55);
      --shadow: 0 6px 16px rgba(0,0,0,0.06);
      --control-bg: rgba(255,255,255,0.98);
      --control-border: rgba(0,0,0,0.06);
      --black: #111111;
      --white: #ffffff;
    }

    /* page centering */
    html,body{
      height:100%;
      margin:0;
      background: transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: 'Playfair Display', serif;
      font-style: italic;
      -webkit-font-smoothing:antialiased;
    }

    /* pill card (single widget box) */
    .clock {
      background: var(--pill-bg);
      padding: 14px 20px;
      border-radius: 19px; /* pill shape */
      box-shadow: var(--shadow);
      width: 260px;
      text-align: center;
      color: var(--text);
      font-variant-numeric: tabular-nums;
      position: relative;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .time {
      font-size: 40px;
      letter-spacing: 1px;
      /* reduce heavy shadow for minimal look */
      text-shadow: 1px 1px 3px rgba(0,0,0,0.10);
      display:block;
      line-height:1;
      color: var(--black);
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-weight: 700;
      -webkit-font-smoothing: antialiased;
    }

    .meta {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 1px;
    }

    /* button row (inside the pill) */
    .btn-row {
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      width:100%;
    }

    /* buttons: black primary, minimal secondary */
    .btn {
      background: var(--control-bg);
      border: 1px solid var(--control-border);
      padding:8px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:700;
      color: var(--black);
      font-size:14px;
      font-family: 'Playfair Display', serif;
      font-style: italic;
      box-shadow: none;
      transition: transform .06s ease, opacity .06s ease;
    }
    .btn:active { transform: translateY(1px); }

    .btn.primary {
      background: var(--black);
      color: var(--white);
      border-color: rgba(0,0,0,0.12);
    }
    .btn.secondary {
      background: transparent;
      color: var(--black);
      border-color: var(--control-border);
      opacity: 0.95;
    }

    /* stacked controllers inside same widget */
    .controllers {
      display:flex;
      flex-direction:column;
      gap:5px;
      width:50%;
      align-items:stretch;
      padding: 6px 4px 2px 4px;
      box-sizing: border-box;
    }

    .ctrl-row {
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      width:100%;
      box-sizing:border-box;
      flex-direction: row;
    }

    .label {
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      padding-left:6px;
    }

    .num {
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:var(--control-bg);
      border-radius:10px;
      padding:6px 8px;
      border:1px solid var(--control-border);
      min-width:110px;
      justify-content:center;
    }
    .num button {
      width:30px;
      height:28px;
      padding:0;
      border-radius:8px;
      border:1px solid var(--control-border);
      background:transparent;
      cursor:pointer;
      font-weight:700;
      color:var(--black);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
    }
    .num input {
      width:46px;
      text-align:center;
      border:0;
      font-weight:800;
      color:var(--black);
      background:transparent;
      font-size:13px;
      -moz-appearance:textfield;
      -webkit-appearance: none;
    }

    .small {
      font-size:11px;
      color:var(--muted);
    }

    @media (max-width:360px){
      .clock { width:200px; padding:12px 14px; }
      .time { font-size:34px; }
      .btn { font-size:13px; padding:6px 10px; }
      .num input { width:36px; }
    }
  </style>
</head>
<body>
  <div>
    <div class="clock" role="application" aria-label="Pomodoro timer">
      <span class="meta" style="margin-bottom:4px;">
        ⏳ Work • Break Timer
      </span>

      <span class="time" id="display">25:00</span>
      <span class="meta" id="modeLabel">Work • Session 1</span>

      <div class="btn-row" aria-hidden="false" style="margin-top:6px;">
        <button class="btn primary" id="startPause" aria-pressed="false">Start</button>
        <button class="btn secondary" id="skip">Skip</button>
        <button class="btn secondary" id="reset">Reset</button>
      </div>

      <div class="controllers" aria-hidden="false">
        <div class="ctrl-row" style="align-items:center;">
          <div style="display:flex;flex-direction:column;align-items:flex-start;">
            <div class="label">Work</div>
            <div class="small">minutes</div>
          </div>
          <div class="num" title="Work minutes">
            <button id="decWork" aria-label="Decrease work minutes">−</button>
            <input id="workInput" type="number" min="1" max="180" value="25" aria-label="Work minutes">
            <button id="incWork" aria-label="Increase work minutes">+</button>
          </div>
        </div>

        <div class="ctrl-row" style="align-items:center;">
          <div style="display:flex;flex-direction:column;align-items:flex-start;">
            <div class="label">Break</div>
            <div class="small">minutes</div>
          </div>
          <div class="num" title="Break minutes">
            <button id="decBreak" aria-label="Decrease break minutes">−</button>
            <input id="breakInput" type="number" min="1" max="60" value="5" aria-label="Break minutes">
            <button id="incBreak" aria-label="Increase break minutes">+</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // Elements
      const display = document.getElementById('display');
      const modeLabel = document.getElementById('modeLabel');
      const startPauseBtn = document.getElementById('startPause');
      const resetBtn = document.getElementById('reset');
      const skipBtn = document.getElementById('skip');

      const workInput = document.getElementById('workInput');
      const breakInput = document.getElementById('breakInput');
      const incWork = document.getElementById('incWork');
      const decWork = document.getElementById('decWork');
      const incBreak = document.getElementById('incBreak');
      const decBreak = document.getElementById('decBreak');

      // Settings / state (persisted in localStorage)
      const STORAGE_KEY = 'pastel-pomodoro-v1';
      const defaultState = {
        workMinutes: 25,
        breakMinutes: 5,
        longBreakMinutes: 15,
        sessionsBeforeLongBreak: 4,
        mode: 'work', // 'work' | 'break'
        running: false,
        remainingSeconds: 25 * 60,
        sessionCount: 0, // completed work sessions in current cycle
        lastTick: null
      };

      function loadState(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return {...defaultState};
          const parsed = JSON.parse(raw);
          return Object.assign({}, defaultState, parsed);
        }catch(e){
          return {...defaultState};
        }
      }
      function saveState(){
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
      }

      let state = loadState();

      // Ensure inputs reflect persisted settings
      workInput.value = state.workMinutes;
      breakInput.value = state.breakMinutes;

      // Utility: format seconds -> MM:SS
      function fmt(seconds){
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
      }

      // Update UI
      function updateUI(){
        display.textContent = fmt(state.remainingSeconds);
        const sessionNumber = Math.max(1, state.sessionCount + (state.mode === 'break' ? 0 : 1));
        const modeText = (state.mode === 'work') ? 'Work' : 'Break';
        modeLabel.textContent = `${modeText} • Session ${sessionNumber}`;
        startPauseBtn.textContent = state.running ? 'Pause' : 'Start';
        startPauseBtn.setAttribute('aria-pressed', String(state.running));
        // sync inputs
        workInput.value = state.workMinutes;
        breakInput.value = state.breakMinutes;
      }

      // Switch mode and reset remainingSeconds accordingly
      function switchMode(nextMode){
        state.mode = nextMode;
        if(nextMode === 'work'){
          state.remainingSeconds = state.workMinutes * 60;
        } else {
          // decide long break vs short break
          const willBeLong = (state.sessionCount > 0) && (state.sessionCount % state.sessionsBeforeLongBreak === 0);
          state.remainingSeconds = willBeLong ? state.longBreakMinutes * 60 : state.breakMinutes * 60;
        }
        saveState();
        updateUI();
      }

      // End of a session
      function completeSession(){
        if(state.mode === 'work'){
          state.sessionCount = (state.sessionCount || 0) + 1;
        }
        // auto-switch
        if(state.mode === 'work'){
          switchMode('break');
        } else {
          switchMode('work');
        }
        // notify
        beep();
      }

      // Timer loop
      let tickTimer = null;
      function startTimer(){
        if(state.running) return;
        state.running = true;
        state.lastTick = Date.now();
        saveState();
        tick();
      }

      function pauseTimer(){
        state.running = false;
        state.lastTick = null;
        saveState();
        if(tickTimer) { clearTimeout(tickTimer); tickTimer = null; }
      }

      function resetTimer(){
        pauseTimer();
        state.mode = 'work';
        state.sessionCount = 0;
        state.remainingSeconds = state.workMinutes * 60;
        state._celebrated = false;
        saveState();
        updateUI();
      }

      function skipTimer(){
        // Immediately complete current session
        pauseTimer();
        completeSession();
      }

      function tick(){
        if(!state.running) return;
        const now = Date.now();
        const elapsedMs = now - (state.lastTick || now);
        const elapsedSec = Math.floor(elapsedMs / 1000);
        if(elapsedSec >= 1){
          state.remainingSeconds = Math.max(0, state.remainingSeconds - elapsedSec);
          state.lastTick = now;
          saveState();
          updateUI();
        }

        if(state.remainingSeconds <= 0){
          // complete and continue
          completeSession();
          // if still running, continue automatically
          if(state.running){
            state.lastTick = Date.now();
            saveState();
          } else {
            pauseTimer();
          }
        }

        // schedule next tick (aim to sync with real second boundaries)
        if(state.running){
          const next = 1000 - (Date.now() % 1000) + 10;
          tickTimer = setTimeout(tick, next);
        }
      }

      // Simple beep using WebAudio
      function beep(){
        try{
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine';
          o.frequency.value = 880;
          g.gain.value = 0.0001;
          o.connect(g);
          g.connect(ctx.destination);
          // ramp up quickly
          g.gain.linearRampToValueAtTime(0.12, ctx.currentTime + 0.01);
          o.start();
          // ramp down and stop
          g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.9);
          o.stop(ctx.currentTime + 1);
        }catch(e){
          console.warn('beep failed', e);
        }
      }

      // Event wiring (no dialogs)
      startPauseBtn.addEventListener('click', ()=>{
        if(state.running){ pauseTimer(); }
        else { startTimer(); }
        updateUI();
      });

      resetBtn.addEventListener('click', ()=>{
        resetTimer();
      });

      skipBtn.addEventListener('click', ()=>{
        skipTimer();
      });

      // Settings adjustments
      function applySettingsFromInputs(){
        const workVal = Math.max(1, Math.min(180, Number(workInput.value) || 25));
        const breakVal = Math.max(1, Math.min(60, Number(breakInput.value) || 5));
        // Preserve proportion of remaining time when changing the same-mode length
        if(state.mode === 'work' && state.workMinutes > 0){
          const proportion = state.remainingSeconds / (state.workMinutes * 60);
          state.workMinutes = workVal;
          state.remainingSeconds = Math.max(1, Math.round(proportion * state.workMinutes * 60));
        } else if(state.mode === 'break' && state.breakMinutes > 0){
          const proportion = state.remainingSeconds / (state.breakMinutes * 60);
          state.breakMinutes = breakVal;
          state.remainingSeconds = Math.max(1, Math.round(proportion * state.breakMinutes * 60));
        } else {
          state.workMinutes = workVal;
          state.breakMinutes = breakVal;
        }
        // Also update stored values
        state.workMinutes = workVal;
        state.breakMinutes = breakVal;
        saveState();
        updateUI();
      }

      incWork.addEventListener('click', ()=> { workInput.value = Number(workInput.value || 25) + 1; applySettingsFromInputs(); });
      decWork.addEventListener('click', ()=> { workInput.value = Math.max(1, Number(workInput.value || 25) - 1); applySettingsFromInputs(); });
      incBreak.addEventListener('click', ()=> { breakInput.value = Number(breakInput.value || 5) + 1; applySettingsFromInputs(); });
      decBreak.addEventListener('click', ()=> { breakInput.value = Math.max(1, Number(breakInput.value || 5) - 1); applySettingsFromInputs(); });

      // typing into inputs
      workInput.addEventListener('change', applySettingsFromInputs);
      breakInput.addEventListener('change', applySettingsFromInputs);
      workInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') applySettingsFromInputs(); });
      breakInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') applySettingsFromInputs(); });

      // keyboard shortcuts: space to start/pause, r to reset, s to skip
      window.addEventListener('keydown', (e)=>{
        if(e.key === ' '){
          e.preventDefault();
          startPauseBtn.click();
        } else if(e.key.toLowerCase() === 'r'){
          resetBtn.click();
        } else if(e.key.toLowerCase() === 's'){
          skipBtn.click();
        }
      });

      // Initialize behavior on load
      (function init(){
        if(!state.remainingSeconds || state.remainingSeconds <= 0){
          state.remainingSeconds = state.workMinutes * 60;
        }
        workInput.value = state.workMinutes;
        breakInput.value = state.breakMinutes;
        updateUI();

        // If state.running was true and lastTick exists, resume with corrected elapsed time
        if(state.running && state.lastTick){
          const since = Math.floor((Date.now() - state.lastTick) / 1000);
          if(since > 0){
            state.remainingSeconds = Math.max(0, state.remainingSeconds - since);
            state.lastTick = Date.now();
            saveState();
          }
          startTimer();
        }
      })();

      // Persist on unload
      window.addEventListener('beforeunload', saveState);

      // Expose for debug
      window.__pomodoro = {
        getState: ()=> JSON.parse(JSON.stringify(state)),
        start: ()=> { startTimer(); updateUI(); },
        pause: ()=> { pauseTimer(); updateUI(); },
        reset: ()=> { resetTimer(); },
      };

    })();
  </script>
</body>
</html>
